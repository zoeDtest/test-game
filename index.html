
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <!-- 关键：移动端视口设置，禁止缩放 -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MOON RUNNER: ETERNAL (Mobile)</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@500;700&display=swap');

        /* --- 基础设置 --- */
        body {
            margin: 0;
            overflow: hidden;
            background: #000;
            height: 100vh;
            width: 100vw;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: 'Rajdhani', sans-serif;
            color: #fff;
            user-select: none; /* 禁止选中文本 */
            -webkit-user-select: none;
            touch-action: none; /* 禁止默认触摸行为 */
        }

        /* 背景星空 */
        #stars-bg {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: -1;
            background: radial-gradient(ellipse at bottom, #1b2735 0%, #090a0f 100%);
        }

        /* 游戏容器 - 适配移动端比例 */
        #game-frame {
            position: relative;
            /* 保持宽高比，但在移动端自动缩放以适应屏幕 */
            width: 100%;
            max-width: 1024px;
            aspect-ratio: 16/10; 
            max-height: 100vh;
            
            box-shadow: 0 0 50px rgba(0, 210, 255, 0.1);
            border: 1px solid rgba(0, 210, 255, 0.3);
            border-radius: 4px;
            background: #000;
            overflow: hidden;
        }

        canvas { 
            display: block; 
            width: 100%; 
            height: 100%; 
        }

        /* --- 屏幕滤镜 --- */
        .screen-fx {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 5;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%);
            background-size: 100% 4px;
            box-shadow: inset 0 0 80px rgba(0,0,0,0.6);
        }

        /* --- UI 层 --- */
        .ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 20; pointer-events: none;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
        }
        
        /* 启用点击的元素 */
        #start-screen, #victory-screen, .touch-btn, .btn { pointer-events: auto; }

        /* --- 移动端虚拟按键 (新增) --- */
        #mobile-controls {
            position: absolute;
            bottom: 20px; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            z-index: 30;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            padding: 20px;
            box-sizing: border-box;
        }

        .control-group {
            pointer-events: auto;
            display: flex;
            gap: 15px;
        }

        .touch-btn {
            background: rgba(0, 210, 255, 0.1);
            border: 2px solid rgba(0, 210, 255, 0.3);
            border-radius: 50%;
            backdrop-filter: blur(4px);
            color: rgba(255, 255, 255, 0.8);
            font-family: 'Orbitron';
            display: flex; justify-content: center; align-items: center;
            user-select: none;
            transition: all 0.1s;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.5);
        }

        /* 按下状态 */
        .touch-btn:active, .touch-btn.active {
            background: rgba(0, 210, 255, 0.4);
            border-color: #fff;
            transform: scale(0.95);
            box-shadow: 0 0 20px rgba(0, 210, 255, 0.6);
        }

        /* 左侧方向键 */
        .dpad-btn {
            width: 60px; height: 60px;
            font-size: 24px;
            clip-path: polygon(20% 0%, 80% 0%, 100% 20%, 100% 80%, 80% 100%, 20% 100%, 0% 80%, 0% 20%);
        }

        /* 右侧功能键 */
        .action-group {
            display: flex;
            align-items: flex-end;
            gap: 20px;
        }

        .lens-btn {
            width: 50px; height: 50px;
            border-color: rgba(255, 80, 80, 0.5);
            background: rgba(255, 50, 50, 0.1);
            color: #ffaaaa;
            font-size: 12px; font-weight: bold;
            margin-bottom: 20px; /* 稍微错开 */
        }
        .lens-btn:active, .lens-btn.active {
            background: rgba(255, 50, 50, 0.4);
            box-shadow: 0 0 20px rgba(255, 50, 50, 0.6);
        }

        .fly-btn {
            width: 80px; height: 80px;
            font-size: 16px; font-weight: bold;
            border-width: 3px;
        }

        /* --- 菜单按钮 --- */
        .btn {
            background: rgba(0, 210, 255, 0.1);
            border: 1px solid rgba(0, 210, 255, 0.5);
            color: #00d2ff; padding: 12px 30px;
            font-family: 'Orbitron'; font-size: 14px;
            margin: 10px; cursor: pointer;
            text-transform: uppercase;
        }

        /* --- HUD 信息 --- */
        #hud {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; display: none;
        }
        .hud-top-left {
            position: absolute; top: 10px; left: 20px;
            width: 150px; transform: skewX(-15deg);
        }
        .fuel-bar-box {
            height: 6px; background: #333; margin-top: 4px;
            border: 1px solid #555;
        }
        #fuel-fill {
            height: 100%; width: 100%;
            background: linear-gradient(90deg, #ff4d4d, #00d2ff);
        }
        .collect-info {
            position: absolute; top: 10px; right: 20px;
            text-align: right; color: #ffd700;
            font-size: 14px; font-family: 'Orbitron';
        }

        /* --- 开始/结束界面 --- */
        #start-screen, #victory-screen {
            background: rgba(5, 8, 15, 0.9);
            backdrop-filter: blur(8px);
            transition: opacity 0.5s;
        }
        h1 {
            font-family: 'Orbitron'; font-size: 40px; margin: 0;
            background: linear-gradient(180deg, #fff, #00d2ff);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            text-shadow: 0 0 20px rgba(0,210,255,0.5);
        }

        /* 移动端文字适配 */
        @media (max-width: 768px) {
            h1 { font-size: 32px; }
            .btn { padding: 10px 20px; font-size: 12px; }
            .dpad-btn { width: 55px; height: 55px; }
            .fly-btn { width: 70px; height: 70px; }
        }

    </style>
</head>
<body>

<div id="stars-bg"></div>

<div id="game-frame">
    <canvas id="gameCanvas"></canvas>
    <div class="screen-fx"></div>

    <!-- HUD -->
    <div id="hud">
        <div class="hud-top-left">
            <div style="font-size:10px; color:#00d2ff;">FUEL SYSTEM</div>
            <div class="fuel-bar-box"><div id="fuel-fill"></div></div>
        </div>
        <div class="collect-info">
            DATA: <span id="col-cur">0</span>/<span id="col-max">0</span>
        </div>
    </div>

    <!-- 移动端虚拟按键 -->
    <div id="mobile-controls">
        <div class="control-group">
            <div class="touch-btn dpad-btn" id="btn-left">←</div>
            <div class="touch-btn dpad-btn" id="btn-right">→</div>
        </div>
        
        <div class="control-group action-group">
            <div class="touch-btn lens-btn" id="btn-lens">LENS</div>
            <div class="touch-btn fly-btn" id="btn-fly">FLY</div>
        </div>
    </div>

    <!-- 开始菜单 -->
    <div id="start-screen" class="ui-layer">
        <h1>MOON RUNNER</h1>
        <div style="font-size:12px; color:#889; margin-bottom:20px; letter-spacing:3px;">MOBILE OPERATION</div>
        <div style="display:flex;">
            <button class="btn" onclick="initGame('NORMAL')">START</button>
            <button class="btn" style="border-color:#f55; color:#f55;" onclick="initGame('HARD')">HARD</button>
        </div>
        <div style="margin-top:20px; font-size:10px; color:#666;">
            Landscape Mode Recommended (建议横屏)
        </div>
    </div>

    <!-- 胜利菜单 -->
    <div id="victory-screen" class="ui-layer" style="opacity:0; pointer-events:none;">
        <h1 style="color:#ffd700;">COMPLETE</h1>
        <div style="margin:20px; text-align:center; color:#ccc;">
            <div>TIME: <span id="res-time" style="color:#fff;">0s</span></div>
            <div>DEATHS: <span id="res-death" style="color:#f55;">0</span></div>
        </div>
        <button class="btn" onclick="location.reload()">RETRY</button>
    </div>
</div>

<script>
/**
 * 奔月揽星 - 移动端适配版
 */

const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

// 内部逻辑分辨率 (保持固定，通过CSS缩放)
const VIEW_W = 1024;
const VIEW_H = 640;
canvas.width = VIEW_W;
canvas.height = VIEW_H;

// --- 触摸控制逻辑 (核心新增) ---
const KEYS = {
    ArrowLeft: false,
    ArrowRight: false,
    ArrowUp: false,
    Space: false
};

function setupTouchControls() {
    const bindBtn = (id, key) => {
        const btn = document.getElementById(id);
        
        // 触摸开始
        btn.addEventListener('touchstart', (e) => {
            e.preventDefault(); // 防止双击缩放等
            KEYS[key] = true;
            btn.classList.add('active');
        }, {passive: false});

        // 触摸结束
        btn.addEventListener('touchend', (e) => {
            e.preventDefault();
            KEYS[key] = false;
            btn.classList.remove('active');
        }, {passive: false});

        // 兼容鼠标 (方便PC调试)
        btn.addEventListener('mousedown', (e) => { KEYS[key] = true; btn.classList.add('active'); });
        btn.addEventListener('mouseup', (e) => { KEYS[key] = false; btn.classList.remove('active'); });
    };

    bindBtn('btn-left', 'ArrowLeft');
    bindBtn('btn-right', 'ArrowRight');
    bindBtn('btn-fly', 'ArrowUp');
    bindBtn('btn-lens', 'Space');
}
setupTouchControls();

// 键盘控制依然保留
window.addEventListener('keydown', e => { if(KEYS.hasOwnProperty(e.code)) KEYS[e.code] = true; if(e.code === 'Space') KEYS.Space = true; });
window.addEventListener('keyup', e => { if(KEYS.hasOwnProperty(e.code)) KEYS[e.code] = false; if(e.code === 'Space') KEYS.Space = false; });


// --- 游戏配置与状态 ---
let SETTINGS = {};
const PRESETS = {
    NORMAL: { g: 0.25, acc: 0.5, fric: 0.75, maxH: 4.5, maxV: 6.0, jet: 0.5, fuel: 100, burn: 0.6, regen: 1.5 },
    HARD: { g: 0.35, acc: 0.4, fric: 0.9, maxH: 6.0, maxV: 7.0, jet: 0.65, fuel: 60, burn: 0.9, regen: 0.5 }
};

const STATE = {
    mode: 'MENU', frame: 0, startT: 0, deaths: 0, collected: 0, lens: false,
    cam: {x:0, y:0}, spawn: {x:100, y:1000}
};

let platforms = [], collectibles = [], particles = [];
const moonGoal = {x: 3400, y: 200, r: 80};
const Type = { NORM:0, PHASE:1, ICE:2, SPIKE:3, SAVE:4 };

// --- 游戏循环 ---
function initGame(mode) {
    SETTINGS = PRESETS[mode];
    document.getElementById('start-screen').style.opacity = 0;
    setTimeout(() => document.getElementById('start-screen').style.display = 'none', 500);
    document.getElementById('hud').style.display = 'block';
    
    buildLevel();
    STATE.mode = 'PLAY'; STATE.startT = Date.now();
    player.reset();
    loop();
}

// --- 实体类 ---
class Player {
    constructor() { this.w=20; this.h=36; this.reset(); }
    reset() {
        this.x = STATE.spawn.x; this.y = STATE.spawn.y;
        this.vx = 0; this.vy = 0; this.fuel = SETTINGS.fuel;
        this.grounded = false;
        spawnFX(this.x, this.y, 20, '#0ff');
    }
    update() {
        if(KEYS.ArrowLeft) this.vx -= SETTINGS.acc;
        if(KEYS.ArrowRight) this.vx += SETTINGS.acc;
        
        if(KEYS.ArrowUp && this.fuel > 0) {
            if(this.vy > -SETTINGS.maxV) this.vy -= SETTINGS.jet;
            this.fuel -= SETTINGS.burn;
            this.grounded = false;
            if(STATE.frame % 3 === 0) spawnFX(this.x+10, this.y+36, 1, '#fa0', 2);
        }

        this.vy += SETTINGS.g;
        this.vy *= 0.98;
        let fric = this.grounded ? (this.ice ? 0.98 : SETTINGS.fric) : 0.96;
        this.vx *= fric;
        if(Math.abs(this.vx) > SETTINGS.maxH) this.vx = Math.sign(this.vx) * SETTINGS.maxH;
        
        if(this.grounded && !KEYS.ArrowUp && this.fuel < SETTINGS.fuel) this.fuel += SETTINGS.regen;

        this.x += this.vx; this.y += this.vy;
        this.grounded = false; this.ice = false;
        
        if(this.y > 1500) this.die();
        this.collide();
    }
    collide() {
        for(let p of platforms) {
            if(p.t === Type.PHASE && !STATE.lens) continue;
            if(this.x < p.x+p.w && this.x+this.w > p.x && this.y+this.h > p.y && this.y < p.y+p.h) {
                if(p.t === Type.SPIKE) {
                    if(this.x+4 < p.x+p.w && this.x+16 > p.x && this.y+8 < p.y+p.h && this.y+32 > p.y) this.die();
                    continue;
                }
                if(this.vy >= 0 && (this.y+this.h - this.vy) <= p.y+12) {
                    this.y = p.y-this.h; this.vy = 0; this.grounded = true;
                    if(p.t === Type.ICE) { this.ice = true; this.vx += p.slide; }
                    if(p.t === Type.SAVE && !p.act) {
                        platforms.forEach(k=>k.act=false); p.act = true;
                        STATE.spawn = {x:p.x+p.w/2-10, y:p.y-40};
                        spawnFX(p.x+p.w/2, p.y, 15, '#0f0');
                    }
                }
            }
        }
    }
    die() {
        STATE.deaths++;
        spawnFX(this.x, this.y, 30, '#f00');
        this.reset();
    }
    draw(ctx) {
        ctx.save(); ctx.translate(this.x+10, this.y+18);
        ctx.fillStyle = '#889'; ctx.fillRect(-8,-10,16,20); // pack
        ctx.fillStyle = this.fuel > 20 ? '#0f0' : '#f00'; ctx.fillRect(-6,-8,4,4);
        ctx.fillStyle = '#eee'; ctx.beginPath(); ctx.roundRect(-8,-6,16,22,4); ctx.fill(); // body
        ctx.fillStyle = '#fff'; ctx.beginPath(); ctx.arc(0,-12,10,0,Math.PI*2); ctx.fill(); // head
        ctx.fillStyle = '#345'; ctx.beginPath(); ctx.arc(0,-12,7,0,Math.PI*2); ctx.fill(); // visor
        ctx.restore();
    }
}

const player = new Player();

// --- 关卡构建 ---
function buildLevel() {
    platforms = []; collectibles = [];
    const addP = (x,y,w,h,t,s=0) => platforms.push({x,y,w,h,t,slide:s,act:false});
    
    addP(0,1100,300,50,0); addP(350,1050,100,20,0); addP(500,1000,80,20,4); // Start
    
    addP(650,1100,200,20,2,4); // Ice trap
    addP(900,1150,100,20,0); collectibles.push({x:950, y:1100, c:false});
    
    addP(600,900,100,20,0); addP(750,850,150,20,3); addP(750,800,40,10,0); addP(920,800,80,20,0); // Spike jump
    
    addP(1100,950,150,20,0); addP(1200,950,50,20,4); // Save 2
    
    // Tower
    addP(1300,850,80,20,1); addP(1450,750,80,20,0); addP(1300,650,80,20,1);
    collectibles.push({x:1340, y:620, c:false});
    
    // Long run
    addP(1500,600,300,20,0); addP(1600,590,100,10,3); addP(1900,600,100,20,4); // Save 3
    
    // Final
    addP(2100,550,150,20,2,-3); addP(2300,450,80,20,1); addP(2500,450,20,100,3);
    addP(2300,250,60,20,1); collectibles.push({x:2330, y:220, c:false});
    
    addP(2600,400,100,20,0); addP(2800,300,200,20,0);
    
    document.getElementById('col-max').innerText = collectibles.length;
}

// --- 渲染循环 ---
function loop() {
    if(STATE.mode !== 'PLAY') return;
    STATE.frame++;
    STATE.lens = KEYS.Space;

    player.update();
    
    // Collectibles
    collectibles.forEach(c => {
        if(!c.c && Math.hypot(player.x+10-c.x, player.y+18-c.y) < 25) {
            c.c = true; STATE.collected++;
            document.getElementById('col-cur').innerText = STATE.collected;
            spawnFX(c.x, c.y, 15, '#ff0');
        }
    });

    // Camera
    let tx = player.x - VIEW_W*0.4, ty = player.y - VIEW_H*0.6;
    STATE.cam.x += (tx - STATE.cam.x)*0.1; STATE.cam.y += (ty - STATE.cam.y)*0.1;
    STATE.cam.x = Math.max(0, Math.min(STATE.cam.x, 3500-VIEW_W));
    STATE.cam.y = Math.max(0, Math.min(STATE.cam.y, 1500-VIEW_H));

    // Win
    if(Math.hypot(player.x-moonGoal.x, player.y-moonGoal.y) < 80) {
        document.getElementById('res-time').innerText = ((Date.now()-STATE.startT)/1000).toFixed(1)+'s';
        document.getElementById('res-death').innerText = STATE.deaths;
        let v = document.getElementById('victory-screen');
        v.style.opacity = 1; v.style.pointerEvents = 'auto';
        STATE.mode = 'WIN';
        return;
    }

    draw();
    requestAnimationFrame(loop);
}

function spawnFX(x, y, n, c, s=1) {
    for(let i=0; i<n; i++) particles.push({x, y, vx:(Math.random()-0.5)*4*s, vy:(Math.random()-0.5)*4*s, l:1, c});
}

function draw() {
    ctx.clearRect(0,0,VIEW_W,VIEW_H);
    ctx.save(); ctx.translate(-STATE.cam.x, -STATE.cam.y);

    // Moon
    ctx.shadowBlur=60; ctx.shadowColor='#ffa'; ctx.fillStyle='#ffa'; 
    ctx.beginPath(); ctx.arc(moonGoal.x, moonGoal.y, moonGoal.r, 0, Math.PI*2); ctx.fill(); ctx.shadowBlur=0;

    // Platforms
    platforms.forEach(p => {
        if(p.t===3) { // Spike
            ctx.fillStyle='#d32'; ctx.beginPath();
            for(let i=0;i<p.w;i+=20) { ctx.moveTo(p.x+i,p.y+p.h); ctx.lineTo(p.x+i+10,p.y); ctx.lineTo(p.x+i+20,p.y+p.h); }
            ctx.fill(); return;
        }
        if(p.t===4) { // Save
            ctx.fillStyle = p.act ? '#2e7' : '#456'; ctx.fillRect(p.x,p.y,p.w,p.h);
            if(p.act) { ctx.fillStyle='rgba(50,255,100,0.15)'; ctx.fillRect(p.x,p.y-80,p.w,80); }
            return;
        }
        
        // Normal/Phase/Ice
        ctx.save();
        if(p.t===0) { ctx.fillStyle='#234'; ctx.fillRect(p.x,p.y,p.w,p.h); ctx.fillStyle='#0df'; ctx.fillRect(p.x,p.y,p.w,3); }
        else if(p.t===1) {
            if(STATE.lens) { ctx.fillStyle='rgba(255,50,50,0.3)'; ctx.strokeStyle='#f44'; ctx.lineWidth=2; ctx.fillRect(p.x,p.y,p.w,p.h); ctx.strokeRect(p.x,p.y,p.w,p.h); }
            else { ctx.strokeStyle='rgba(255,50,50,0.2)'; ctx.setLineDash([4,4]); ctx.strokeRect(p.x,p.y,p.w,p.h); }
        }
        else if(p.t===2) {
            let gr = ctx.createLinearGradient(p.x,p.y,p.x,p.y+p.h); gr.addColorStop(0,'rgba(100,200,255,0.6)'); gr.addColorStop(1,'#048');
            ctx.fillStyle=gr; ctx.fillRect(p.x,p.y,p.w,p.h);
            ctx.fillStyle='rgba(255,255,255,0.3)';
            let off = (p.slide>0 ? STATE.frame*2 : -STATE.frame*2)%20;
            for(let i=0;i<p.w;i+=30) { if(p.x+i+off < p.x+p.w-5) ctx.fillRect(p.x+i+off,p.y+5,4,2); }
        }
        ctx.restore();
    });

    // Collectibles
    collectibles.forEach(c => {
        if(!c.c) {
            ctx.save(); ctx.translate(c.x, c.y + Math.sin(STATE.frame*0.1)*5); ctx.rotate(STATE.frame*0.05);
            ctx.fillStyle='#fd0'; ctx.shadowBlur=10; ctx.shadowColor='#fd0';
            ctx.fillRect(-6,-6,12,12); ctx.restore();
        }
    });

    player.draw(ctx);

    // Particles
    for(let i=particles.length-1; i>=0; i--) {
        let p=particles[i]; p.x+=p.vx; p.y+=p.vy; p.l-=0.03;
        ctx.globalAlpha=Math.max(0,p.l); ctx.fillStyle=p.c; ctx.fillRect(p.x,p.y,3,3);
        if(p.l<=0) particles.splice(i,1);
    }
    ctx.globalAlpha=1;
    ctx.restore();

    // Lens Effect
    if(STATE.lens) {
        ctx.strokeStyle = 'rgba(255, 50, 50, 0.3)'; ctx.lineWidth=4; ctx.strokeRect(0,0,VIEW_W,VIEW_H);
    }

    // UI Updates
    document.getElementById('fuel-fill').style.width = player.fuel + '%';
}

</script>
</body>
</html>

